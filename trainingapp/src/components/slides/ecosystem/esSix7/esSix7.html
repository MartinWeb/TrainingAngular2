<h2 class="standard-title">
	<span class="title-category">Ecosystem</span>
	ES6 Introduction - Promises
</h2>

<p>
	If you have already worked with <em>angular 1</em>, you probably
	already now <em>promises</em>. <em>ES6</em> now have a native implementation
	for that.
</p>
<p>
	Promises are there to help working with callbacks, to make their use easier, more
	readable, more maintainable. Below is a compareason of the use of <em>Promises</em>
</p>
<p class="todo">Ajouter une mini animation ou minimum image pour la clarifier le concept</p>

<editor>
	<editortab title="without-promises-simple.js" fileType="js">

//My callback for logs
let logUser= function(user){
	console.log(user.firstName);
	console.log(user.lastName);
};

//My function which retrieve a user and call the callback and
// pass it the user
let getUser= function(userId, logCallback){
	myRestRequest().success(function(retrievedUser){
		logCallback(retrievedUser);
	});
};

//Finally I call my function with needed arguments
getUser(userId, logUser);

	</editortab>
	<editortab title="without-promises-less-easy.js" fileType="js">

//Hum, but what shoudl I do if logUser also needs a callback..

//My callback which is used when everithing ended
let theEnd= function(){
	state= ended;
	console.log('end');
};

//My callback for logs
let logUser= function(user, endCallback){
	console.log(user.firstName);
	console.log(user.lastName);
	getMoreData(user).success(function(moreData){
		console.log(moreData);
		endCallback();
	});
};

//My function which retrieve a user and call the callback and
// pass it the user
let getUser= function(userId, logCallback, endCallback){
	myRestRequest().success(function(retrievedUser){
		logCallback(retrievedUser, endCallback);
	})
};

//Finally I call my function with needed arguments
getUser(userId, logUser, theEnd);
	</editortab>
	<editortab title="with-promises-easy.js" fileType="js">

//My callback for logs
let logUser= function(user){
	console.log(user.firstName);
	console.log(user.lastName);
};

//My function which retrieve a user
let getUser= function(userId){
	return new Promise(function(resolve, reject){
		myRestRequest().success(function(retrievedUser){
			resolve(retrievedUser);
		});
	});
};

// Finally I call my function ... without argument, 
// and I define the callback to be called
getUser(userId)
.then(logUser);

	</editortab>
	<editortab title="with-promises-still-easy.js" fileType="js">
//Hum, but what shoudl I do if logUser also needs a callback..

//My callback which is used when everithing ended
let theEnd= function(){
	state= ended;
	console.log('end');
};

//My callback for logs
let logUser= function(user){
	return new Promise(function(resolve, reject){
		console.log(user.firstName);
		console.log(user.lastName);
		getMoreData(user).success(function(moreData){
			console.log(moreData);
			resolve();
		});
	});
};

//My function which retrieve a user (no need to modify it)
let getUser= function(userId){
	return new Promise(function(resolve, reject){
		myRestRequest().success(function(retrievedUser){
			resolve(retrievedUser);
		});
	});
};

//And finally my call
getUser(userId)
.then(logUser)
.then(theEnd);
	</editortab>	
</editor>

<p>
	To understand how that works, you just need to have a good understanding of the
	javascript asynchronism
</p>
<ul>
	<li>The promise is returned before it is resolved</li>
	<li>And the calbacks are set before the <em>resolve</em> method is called</li>
	<li>Finally, the <em>resolve</em>/<em>reject</em> methods are references to the callbacks set on the promise</li>
</ul>
<editor>
	<editortab title="work-with-function.js" fileType="js">

let retrieveFriends= function(person){

	return new Promise(function(resolve, reject){

		var req = new XMLHttpRequest();
		req.open('GET', '/get/users', true); 
		req.onreadystatechange = function (aEvt) {
		  if (req.readyState == 4) {
		     if(req.status == 200)
		      resolve(req.responseText);
		     else
		      reject('error');
		  }
		};
		req.send(null);

	});
};

retrieveFriends(user)
.then(function success(data){
	//...
}), function failure(msg){
	//...
});


	</editortab>
</editor>

<p>
	Here is an example of a very naive implementation
</p>

<editor>
	<editortab title="promises-implementation.js" fileType="js">

class Promise{
	
	constructor(callback){
		this.callback= callback;
	}

 	then(successCallback, errorCallback){
 		this.callback(successCallback, errorCallback);
 	}

}

	</editortab>
</editor>

